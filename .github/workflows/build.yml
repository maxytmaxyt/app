name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: ğŸ· Calculate Version
        id: version
        run: |
          git fetch --tags
          LAST_TAG=$(git tag --list "v*" --sort=-v:refname | head -n 1)
          if [ -z "$LAST_TAG" ]; then
            MAJOR=0; MINOR=1; PATCH=0
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "${LAST_TAG#v}"
            PATCH=$((PATCH + 1))
          fi
          VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=${VERSION#v}" >> $GITHUB_ENV

      - name: ğŸ”§ Ensure Gradle Wrapper
        run: |
          if [ ! -f "./gradlew" ]; then
            echo "Gradle Wrapper fehlt!"
            exit 1
          fi
          chmod +x ./gradlew

      - name: ğŸ— Build Debug APK
        run: ./gradlew assembleDebug --no-daemon

      - name: ğŸ“Œ Commit & Tag Version
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${VERSION}
          git push origin ${VERSION}

      - name: ğŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: DeviceInfoApp-${{ env.VERSION }}
          path: app/build/outputs/apk/debug/app-debug.apk
